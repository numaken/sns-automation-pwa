// src/components/PostGenerator.jsx - AIæŠ•ç¨¿ç”Ÿæˆæ©Ÿèƒ½
import React, { useState } from 'react';
import { Send, Copy, RefreshCw, Twitter, CheckCircle } from 'lucide-react';
import { generateAIPost } from '../utils/openai';
import { postToTwitter } from '../utils/twitter';

const PostGenerator = ({ settings, onUpdateSettings }) => {
  const [generatedPost, setGeneratedPost] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isPosting, setIsPosting] = useState(false);
  const [copySuccess, setCopySuccess] = useState(false);
  const [postSuccess, setPostSuccess] = useState(false);

  // Entryç‰ˆï¼š3è¦ç´ è¨­å®š
  const audienceOptions = [
    'å‰¯æ¥­ãƒ–ãƒ­ã‚¬ãƒ¼', 'Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ãƒ»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'Webãƒ©ã‚¤ã‚¿ãƒ¼',
    'ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼', 'ä¸»å©¦ãƒ»ä¸»å¤«', 'å­¦ç”Ÿãƒ»å¤§å­¦ç”Ÿ', 'ä¼šç¤¾å“¡ãƒ»ã‚µãƒ©ãƒªãƒ¼ãƒãƒ³'
  ];

  const styleOptions = [
    'è¦ªã—ã¿ã‚„ã™ã„', 'å°‚é–€çš„', 'é¢ç™½ã„', 'çœŸé¢ç›®', 'åŠ±ã¾ã—ç³»', 'è³ªå•ç³»'
  ];

  const topicOptions = [
    'å‰¯æ¥­ã¨æœ¬æ¥­ã®æ™‚é–“ç®¡ç†', 'ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®æ–¹æ³•', 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹',
    'SEOå¯¾ç­–ã®åŸºæœ¬', 'SNSé‹ç”¨ã®ã‚³ãƒ„', 'åŠ¹ç‡çš„ãªå­¦ç¿’æ–¹æ³•', 'æœã®ç¿’æ…£ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³',
    'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒã®å·¥å¤«', 'ãƒ–ãƒ­ã‚°è¨˜äº‹ã®ãƒã‚¿åˆ‡ã‚Œå•é¡Œ'
  ];

  // AIæŠ•ç¨¿æ–‡ç”Ÿæˆ
  const handleGenerate = async () => {
    if (!settings.openaiKey) {
      alert('è¨­å®šã§OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    setIsGenerating(true);
    try {
      const prompt = `
ã‚ãªãŸã¯${settings.audience}å‘ã‘ã®SNSæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ãƒ—ãƒ­ã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã§é­…åŠ›çš„ãªTwitteræŠ•ç¨¿æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

å¯¾è±¡èª­è€…: ${settings.audience}
æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«: ${settings.style}
æŠ•ç¨¿ãƒ†ãƒ¼ãƒ: ${settings.topic}

æ¡ä»¶:
- 280æ–‡å­—ä»¥å†…
- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’é«˜ã‚ã‚‹å·¥å¤«
- èª­è€…ã®å…±æ„Ÿã‚’å‘¼ã¶å†…å®¹
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2-3å€‹å«ã‚€
- è¡Œå‹•ã‚’ä¿ƒã™CTAå«ã‚€

æŠ•ç¨¿æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
      `;

      const result = await generateAIPost(prompt, settings.openaiKey);
      setGeneratedPost(result);
    } catch (error) {
      console.error('æŠ•ç¨¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      alert('æŠ•ç¨¿ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
      setIsGenerating(false);
    }
  };

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(generatedPost);
      setCopySuccess(true);
      setTimeout(() => setCopySuccess(false), 2000);
    } catch (error) {
      alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  // TwitteræŠ•ç¨¿
  const handlePost = async () => {
    if (!settings.twitterTokens) {
      alert('è¨­å®šã§Twitteré€£æºã‚’å®Œäº†ã—ã¦ãã ã•ã„');
      return;
    }

    setIsPosting(true);
    try {
      await postToTwitter(generatedPost, settings.twitterTokens);
      setPostSuccess(true);
      setTimeout(() => setPostSuccess(false), 3000);
    } catch (error) {
      console.error('æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
      alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
      setIsPosting(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* è¨­å®šãƒ‘ãƒãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰ */}
      <div className="bg-white rounded-xl p-4 shadow-sm">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">æŠ•ç¨¿è¨­å®š</h2>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              å¯¾è±¡èª­è€…
            </label>
            <select 
              value={settings.audience}
              onChange={(e) => onUpdateSettings({ ...settings, audience: e.target.value })}
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              {audienceOptions.map(option => (
                <option key={option} value={option}>{option}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«
            </label>
            <select 
              value={settings.style}
              onChange={(e) => onUpdateSettings({ ...settings, style: e.target.value })}
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              {styleOptions.map(option => (
                <option key={option} value={option}>{option}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æŠ•ç¨¿ãƒ†ãƒ¼ãƒ
            </label>
            <select 
              value={settings.topic}
              onChange={(e) => onUpdateSettings({ ...settings, topic: e.target.value })}
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              {topicOptions.map(option => (
                <option key={option} value={option}>{option}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* æŠ•ç¨¿ç”Ÿæˆ */}
      <div className="bg-white rounded-xl p-4 shadow-sm">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-gray-900">AIæŠ•ç¨¿ç”Ÿæˆ</h2>
          <button
            onClick={handleGenerate}
            disabled={isGenerating}
            className="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
          >
            {isGenerating ? (
              <RefreshCw className="h-4 w-4 animate-spin" />
            ) : (
              <Send className="h-4 w-4" />
            )}
            <span>{isGenerating ? 'ç”Ÿæˆä¸­...' : 'æŠ•ç¨¿ç”Ÿæˆ'}</span>
          </button>
        </div>

        {generatedPost && (
          <div className="space-y-4">
            <div className="bg-gray-50 p-4 rounded-lg border">
              <p className="text-gray-900 whitespace-pre-wrap">{generatedPost}</p>
              <div className="mt-2 text-xs text-gray-500">
                æ–‡å­—æ•°: {generatedPost.length}/280
              </div>
            </div>

            <div className="flex space-x-3">
              <button
                onClick={handleCopy}
                className="flex-1 flex items-center justify-center space-x-2 bg-gray-100 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-200 transition-colors"
              >
                {copySuccess ? (
                  <CheckCircle className="h-4 w-4 text-green-600" />
                ) : (
                  <Copy className="h-4 w-4" />
                )}
                <span>{copySuccess ? 'ã‚³ãƒ”ãƒ¼å®Œäº†ï¼' : 'ã‚³ãƒ”ãƒ¼'}</span>
              </button>

              <button
                onClick={handlePost}
                disabled={isPosting || !settings.twitterTokens}
                className="flex-1 flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
              >
                {isPosting ? (
                  <RefreshCw className="h-4 w-4 animate-spin" />
                ) : postSuccess ? (
                  <CheckCircle className="h-4 w-4" />
                ) : (
                  <Twitter className="h-4 w-4" />
                )}
                <span>
                  {isPosting ? 'æŠ•ç¨¿ä¸­...' : postSuccess ? 'æŠ•ç¨¿å®Œäº†ï¼' : 'TwitteræŠ•ç¨¿'}
                </span>
              </button>
            </div>
          </div>
        )}
      </div>

      {/* ãƒ’ãƒ³ãƒˆ */}
      <div className="bg-blue-50 rounded-xl p-4">
        <h3 className="text-sm font-medium text-blue-900 mb-2">ğŸ’¡ ä½¿ã„æ–¹ã®ã‚³ãƒ„</h3>
        <ul className="text-sm text-blue-800 space-y-1">
          <li>â€¢ è¨­å®šã§å¯¾è±¡èª­è€…ã‚’å…·ä½“çš„ã«é¸ã¶ã¨åŠ¹æœçš„ã§ã™</li>
          <li>â€¢ æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒ–ãƒ©ãƒ³ãƒ‰ã®å€‹æ€§ã‚’è¡¨ç¾ã§ãã¾ã™</li>
          <li>â€¢ ãƒ†ãƒ¼ãƒã¯èª­è€…ã®é–¢å¿ƒäº‹ã«åˆã‚ã›ã¦é¸æŠã—ã¾ã—ã‚‡ã†</li>
        </ul>
      </div>
    </div>
  );
};

export default PostGenerator;